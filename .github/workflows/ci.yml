name: CI

on:
  pull_request:
  push:
    branches:
      - main

permissions:
  contents: write # Needed for Flutter CI which auto-updates bindings

env:
  CARGO_TERM_COLOR: always
  RUST_MSRV: 1.90.0

jobs:
  rust_RUST_MSRV:
    name: Rust MSRV - build & lint
    runs-on: [self-hosted, aws-ecs-16cpu-64mem-40disk-60m]
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: ./.github/actions/free-disk-space
        with:
          runner-type: self-hosted
      - run: apt install -y --no-install-recommends clang
      - run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain=none
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      - run: rustup install ${{ env.RUST_MSRV }} -c clippy -t wasm32-unknown-unknown && rustup default ${{ env.RUST_MSRV }}
      - run: rustup toolchain install nightly -c rustfmt
      - uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
      - uses: extractions/setup-just@v2
      - run: just clippy
      - run: cargo build -p yttrium --features=wasm --lib --target wasm32-unknown-unknown
      - name: Install cargo-udeps (cached)
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-udeps
      - run: just _rust_ci

  rust_RUST_MSRV_test:
    name: Rust MSRV - test
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: ./.github/actions/free-disk-space
        with:
          runner-type: ubuntu
      - run: rustup install ${{ env.RUST_MSRV }} -c clippy && rustup default ${{ env.RUST_MSRV }}
      - uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
      - run: rustup toolchain install nightly -c rustfmt
      - run: rustup target add wasm32-unknown-unknown
      - uses: extractions/setup-just@v2
      - uses: ./.github/actions/forked-state-docker
        with:
          action: start
      - run: RUST_BACKTRACE=1 RUST_LOG=yttrium=trace cargo test --features=full,test_depends_on_env_REOWN_PROJECT_ID --lib --bins
        env:
          REOWN_PROJECT_ID: ${{ vars.REOWN_PROJECT_ID }}
      - uses: ./.github/actions/forked-state-docker
        if: failure()
        with:
          action: logs
      - uses: ./.github/actions/forked-state-docker
        if: always()
        with:
          action: cleanup

  rust_stable:
    name: Rust stable - build & lint
    runs-on: [self-hosted, aws-ecs-16cpu-64mem-40disk-60m]
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: ./.github/actions/free-disk-space
        with:
          runner-type: self-hosted
      - run: apt install -y --no-install-recommends clang
      - run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain=none
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      - run: rustup install stable -c clippy -t wasm32-unknown-unknown && rustup default stable
      - run: rustup toolchain install nightly -c rustfmt
      - uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
      - uses: extractions/setup-just@v2
      - run: just clippy
      - run: cargo build -p yttrium --features=wasm --lib --target wasm32-unknown-unknown
      - name: Install cargo-udeps (cached)
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-udeps
      - run: just _rust_ci

  rust_stable_test:
    name: Rust stable - test
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: ./.github/actions/free-disk-space
        with:
          runner-type: ubuntu
      - run: rustup update stable && rustup default stable
      - uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
      - run: rustup toolchain install nightly -c rustfmt
      - run: rustup target add wasm32-unknown-unknown
      - uses: extractions/setup-just@v2
      - uses: ./.github/actions/forked-state-docker
        with:
          action: start
      - run: RUST_BACKTRACE=1 RUST_LOG=yttrium=trace cargo test --features=full,test_depends_on_env_REOWN_PROJECT_ID --lib --bins
        env:
          REOWN_PROJECT_ID: ${{ vars.REOWN_PROJECT_ID }}
      - uses: ./.github/actions/forked-state-docker
        if: failure()
        with:
          action: logs
      - uses: ./.github/actions/forked-state-docker
        if: always()
        with:
          action: cleanup

  build_swift_and_test:
    name: Swift Package - Xcode ${{ matrix.xcode }}
    runs-on: macos-14-xlarge
    strategy:
      matrix:
        config:
          - debug
        xcode:
          - "15.4"  # Swift 5.10 - backwards compatibility
          - "16.2"  # Swift 6.x - new version support
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: ./.github/actions/free-disk-space
        with:
          runner-type: macos
      - name: Run sccache-cache
        uses: mozilla-actions/sccache-action@v0.0.4
      - run: rustup update ${{ env.RUST_MSRV }} && rustup default ${{ env.RUST_MSRV }}
      - uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
      - name: Select Xcode ${{ matrix.xcode }}
        run: sudo xcode-select -s /Applications/Xcode_${{ matrix.xcode }}.app/Contents/Developer

      # Build bindings
      - run: make build-xcframework
      - run: make build-utils-xcframework

      # Test that it compiles
      - name: Build ${{ matrix.config }}
        run: make CONFIG=${{ matrix.config }} build-swift-apple-platforms

  build-kotlin-variant:
    runs-on: [self-hosted, aws-ecs-16cpu-64mem-40disk-60m]
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        variant:
          - name: yttrium
            features: "android,erc6492_client,pay,uniffi/cli"
            profile: uniffi-release-kotlin
            lib_suffix: ""
          - name: yttrium-utils
            features: "android,chain_abstraction_client,solana,stacks,sui,ton,tron,eip155,uniffi/cli"
            profile: uniffi-release-kotlin
            lib_suffix: "_utils"
          - name: yttrium-wcpay
            features: "android,pay,uniffi/cli"
            profile: uniffi-release-kotlin-wcpay
            lib_suffix: "_wcpay"

    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/free-disk-space
        with:
          runner-type: self-hosted-kotlin

      - name: Install Android NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r27c

      - name: Install Rust toolchain with all Android targets
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain ${{ env.RUST_MSRV }}
          source "$HOME/.cargo/env"
          rustup target add aarch64-linux-android armv7-linux-androideabi x86_64-linux-android
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install cargo-ndk (cached)
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-ndk

      - uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
          key: kotlin-${{ matrix.variant.name }}

      - name: Build ${{ matrix.variant.name }} native libraries
        run: |
          cargo ndk -t armv7-linux-androideabi -t aarch64-linux-android -t x86_64-linux-android build \
            --profile="${{ matrix.variant.profile }}" \
            --no-default-features \
            --features="${{ matrix.variant.features }}" \
            -p kotlin-ffi
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          CARGO_TARGET_AARCH64_LINUX_ANDROID_RUSTFLAGS: "-C link-arg=-Wl,--gc-sections"
          CARGO_TARGET_ARMV7_LINUX_ANDROIDEABI_RUSTFLAGS: "-C link-arg=-Wl,--gc-sections"
          CARGO_TARGET_X86_64_LINUX_ANDROID_RUSTFLAGS: "-C link-arg=-Wl,--gc-sections"

      - name: Generate Kotlin bindings
        run: |
          cargo run \
            --no-default-features \
            --features="${{ matrix.variant.features }}" \
            -p kotlin-ffi \
            --bin uniffi-bindgen generate \
            --library "target/aarch64-linux-android/${{ matrix.variant.profile }}/libuniffi_yttrium.so" \
            --language kotlin \
            --out-dir bindings

      - name: Strip and prepare artifacts
        run: |
          STRIP="${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip"
          mkdir -p artifacts/arm64-v8a artifacts/armeabi-v7a artifacts/x86_64 artifacts/kotlin
          
          for pair in "aarch64-linux-android:arm64-v8a" "armv7-linux-androideabi:armeabi-v7a" "x86_64-linux-android:x86_64"; do
            target="${pair%%:*}"
            abi="${pair##*:}"
            src="target/${target}/${{ matrix.variant.profile }}/libuniffi_yttrium.so"
            "$STRIP" --strip-all "$src"
            cp "$src" "artifacts/${abi}/libuniffi_yttrium${{ matrix.variant.lib_suffix }}.so"
          done
          
          cp bindings/uniffi/uniffi_yttrium/uniffi_yttrium.kt artifacts/kotlin/
          cp bindings/uniffi/yttrium/yttrium.kt artifacts/kotlin/

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: kotlin-${{ matrix.variant.name }}
          path: artifacts/
          retention-days: 1

  build-kotlin:
    runs-on: [self-hosted, aws-ecs-16cpu-64mem-40disk-60m]
    timeout-minutes: 30
    needs: build-kotlin-variant

    steps:
      - uses: actions/checkout@v4

      - name: Download yttrium artifacts
        uses: actions/download-artifact@v4
        with:
          name: kotlin-yttrium
          path: artifacts/yttrium

      - name: Download yttrium-utils artifacts
        uses: actions/download-artifact@v4
        with:
          name: kotlin-yttrium-utils
          path: artifacts/yttrium-utils

      - name: Download yttrium-wcpay artifacts
        uses: actions/download-artifact@v4
        with:
          name: kotlin-yttrium-wcpay
          path: artifacts/yttrium-wcpay

      - name: Set up Java 11 and 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: |
            11
            17

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Prepare Gradle sources
        run: |
          GEN="crates/kotlin-ffi/android/build/generated"
          
          # yttrium variant
          for abi in arm64-v8a armeabi-v7a x86_64; do
            mkdir -p "$GEN/yttrium/jniLibs/$abi"
            cp "artifacts/yttrium/$abi/libuniffi_yttrium.so" "$GEN/yttrium/jniLibs/$abi/"
          done
          mkdir -p "$GEN/yttrium/kotlin/com/reown/yttrium"
          cp artifacts/yttrium/kotlin/*.kt "$GEN/yttrium/kotlin/com/reown/yttrium/"
          
          # yttrium-utils variant (with package renaming)
          for abi in arm64-v8a armeabi-v7a x86_64; do
            mkdir -p "$GEN/utils/jniLibs/$abi"
            cp "artifacts/yttrium-utils/$abi/libuniffi_yttrium_utils.so" "$GEN/utils/jniLibs/$abi/"
          done
          mkdir -p "$GEN/utils/kotlin/com/reown/yttrium"
          cp artifacts/yttrium-utils/kotlin/*.kt "$GEN/utils/kotlin/com/reown/yttrium/"
          # Rename packages (same approach as release-kotlin-all.yml)
          find "$GEN/utils/kotlin" -type f -name "*.kt" -exec perl -i -pe '
            s/^package uniffi\.yttrium$/package uniffi.yttrium_utils/;
            s/^import uniffi\.yttrium\./import uniffi.yttrium_utils./g;
            s/^package uniffi\.uniffi_yttrium$/package uniffi.uniffi_yttrium_utils/;
            s/^import uniffi\.uniffi_yttrium\./import uniffi.uniffi_yttrium_utils./g;
            s/\buniffi\.yttrium\./uniffi.yttrium_utils./g;
            s/\buniffi\.uniffi_yttrium\./uniffi.uniffi_yttrium_utils./g;
            s/return "uniffi_yttrium"/return "uniffi_yttrium_utils"/g;
          ' {} \;
          
          # yttrium-wcpay variant (with package renaming)
          for abi in arm64-v8a armeabi-v7a x86_64; do
            mkdir -p "$GEN/wcpay/jniLibs/$abi"
            cp "artifacts/yttrium-wcpay/$abi/libuniffi_yttrium_wcpay.so" "$GEN/wcpay/jniLibs/$abi/"
          done
          mkdir -p "$GEN/wcpay/kotlin/com/reown/yttrium"
          cp artifacts/yttrium-wcpay/kotlin/*.kt "$GEN/wcpay/kotlin/com/reown/yttrium/"
          # Rename packages (same approach as release-kotlin-all.yml)
          find "$GEN/wcpay/kotlin" -type f -name "*.kt" -exec perl -i -pe '
            s/^package uniffi\.yttrium$/package uniffi.yttrium_wcpay/;
            s/^import uniffi\.yttrium\./import uniffi.yttrium_wcpay./g;
            s/^package uniffi\.uniffi_yttrium$/package uniffi.uniffi_yttrium_wcpay/;
            s/^import uniffi\.uniffi_yttrium\./import uniffi.uniffi_yttrium_wcpay./g;
            s/\buniffi\.yttrium\./uniffi.yttrium_wcpay./g;
            s/\buniffi\.uniffi_yttrium\./uniffi.uniffi_yttrium_wcpay./g;
            s/return "uniffi_yttrium"/return "uniffi_yttrium_wcpay"/g;
          ' {} \;

      - name: Build Gradle AARs
        working-directory: crates/kotlin-ffi/android
        run: |
          ./gradlew \
            :yttrium:assembleRelease \
            :yttrium-utils:assembleRelease \
            :yttrium-wcpay:assembleRelease

  merge_check:
    name: Merge Check
    needs: [rust_RUST_MSRV, build_swift_and_test, build-kotlin]
    if: ${{ always() && !cancelled() && !failure() }}
    runs-on: ubuntu-latest
    steps:
      - run: echo "CI is successful"
