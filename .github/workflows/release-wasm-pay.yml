name: Build and Release Yttrium WASM Pay

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g. 0.0.1)"
        required: true
  workflow_call:
    inputs:
      version:
        description: "Version to release (e.g. 0.0.1)"
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always
  VERSION: ${{ inputs.version || '0.0.1' }}
  TARGET_BRANCH: ${{ github.ref_name }}

permissions:
  contents: write

jobs:
  build-wasm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Rust nightly toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly
          override: true
          components: rust-src
          target: wasm32-unknown-unknown

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Build WASM package (lean pay-only)
        working-directory: crates/yttrium
        run: |
          RUSTFLAGS="-Zlocation-detail=none -Zfmt-debug=none -Zunstable-options -Cpanic=immediate-abort --cfg getrandom_backend=\"wasm_js\"" \
          wasm-pack build \
            --release \
            --target web \
            --no-default-features \
            --features=wasm,pay \
            -Z build-std=std,panic_abort \
            -Z build-std-features=optimize_for_size

      - name: Display WASM size
        working-directory: crates/yttrium/pkg
        run: |
          echo "=== WASM Binary Size ==="
          ls -lh yttrium_bg.wasm
          echo "Size: $(stat -c%s yttrium_bg.wasm) bytes"

      - name: Create artifacts directory
        run: |
          mkdir -p artifacts
          cp -r crates/yttrium/pkg/* artifacts/
          echo "${{ env.VERSION }}" > artifacts/version.txt

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wasm-pay-artifacts
          path: artifacts/
          retention-days: 30

  create-github-release:
    needs: build-wasm
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          name: wasm-pay-artifacts
          path: wasm-pay/

      - name: Debug listing
        run: |
          echo "Contents of wasm-pay/:"
          ls -lh wasm-pay/

      - name: Create artifacts zip
        run: |
          zip -r wasm-pay-${{ env.VERSION }}.zip wasm-pay/
          echo "Zip created:"
          ls -lh wasm-pay-${{ env.VERSION }}.zip

      - name: Create Release and Upload Assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "wasm-pay-${{ env.VERSION }}" \
            wasm-pay-${{ env.VERSION }}.zip \
            --title "Yttrium WASM Pay ${{ env.VERSION }}" \
            --target "${{ env.TARGET_BRANCH }}" \
            --notes "$(cat <<'EOF'
          Release WASM Pay module version ${{ env.VERSION }}

          **Branch:** ${{ env.TARGET_BRANCH }}

          ## Installation

          Download and extract the zip, then import in your JavaScript/TypeScript project:

          ```typescript
          import init, { PayJson } from './yttrium.js';

          await init();

          const pay = new PayJson(JSON.stringify({
            baseUrl: 'https://pay.walletconnect.com',
            projectId: 'your-project-id',
            apiKey: 'your-api-key',
            sdkName: 'your-sdk',
            sdkVersion: '1.0.0',
            sdkPlatform: 'web',
            bundleId: 'com.example.app'
          }));
          ```
          EOF
          )"
