name: E2E Wallet Balance Check

on:
  schedule:
    - cron: '0 * * * *'  # Every hour
  workflow_dispatch: {}

permissions:
  contents: read

env:
  BASE_USDC: "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"
  OP_USDC: "0x0b2C639c533813f4Aa9D7837CAf62653d097Ff85"
  BASE_RPC: "https://mainnet.base.org"
  OP_RPC: "https://mainnet.optimism.io"
  SOL_RPC: "https://api.mainnet.solana.com"

jobs:
  check-balance:
    name: Check E2E Wallet Balances
    runs-on: ubuntu-latest
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    steps:
      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Install Solana derivation dependencies
        run: |
          # Convert FAUCET_MNEMONIC into a seed buffer.
          # Needed before any Solana HD derivation.
          # @scure/bip39
          #
          # Derive ed25519 key material at m/44'/501'/0'/0'.
          # This matches use_solana_account(0) in Rust test helpers.
          # ed25519-hd-key
          #
          # Construct a Solana keypair from derived seed and output
          # base58 public key for getBalance RPC checks.
          # @solana/web3.js
          npm install --no-save \
            @scure/bip39@2.0.1 \
            ed25519-hd-key@1.3.0 \
            @solana/web3.js@1.98.4

      - name: Derive wallet addresses
        id: addrs
        env:
          TEST_WALLET_PRIVATE_KEY: ${{ secrets.TEST_WALLET_PRIVATE_KEY }}
          FAUCET_MNEMONIC: ${{ secrets.FAUCET_MNEMONIC }}
        run: |
          PAY_ADDR=$(cast wallet address --private-key "$TEST_WALLET_PRIVATE_KEY")
          # Faucet uses MnemonicBuilder default (m/44'/60'/0'/0/0), same as cast default
          FAUCET_ADDR=$(cast wallet address --mnemonic "$FAUCET_MNEMONIC")
          cat > derive-solana.js << 'SCRIPT'
          const { mnemonicToSeedSync } = require('@scure/bip39');
          const { derivePath } = require('ed25519-hd-key');
          const { Keypair } = require('@solana/web3.js');
          // Matches use_solana_account(0) in Rust test helpers: m/44'/501'/0'/0'
          const seed = mnemonicToSeedSync(process.env.FAUCET_MNEMONIC);
          const derived = derivePath("m/44'/501'/0'/0'", Buffer.from(seed).toString('hex')).key;
          console.log(Keypair.fromSeed(derived).publicKey.toBase58());
          SCRIPT
          FAUCET_SOL_ADDR=$(node derive-solana.js)
          echo "pay=$PAY_ADDR" >> $GITHUB_OUTPUT
          echo "faucet=$FAUCET_ADDR" >> $GITHUB_OUTPUT
          echo "faucet_solana=$FAUCET_SOL_ADDR" >> $GITHUB_OUTPUT

      - name: Check pay wallet USDC on Base
        id: pay_usdc_base
        run: |
          BALANCE=$(cast call --rpc-url "$BASE_RPC" "$BASE_USDC" \
            "balanceOf(address)(uint256)" \
            "${{ steps.addrs.outputs.pay }}" | awk '{print $1}')
          echo "balance=$BALANCE" >> $GITHUB_OUTPUT
          echo "Pay wallet USDC on Base (raw): $BALANCE"

      - name: Check faucet ETH on Base
        id: faucet_eth_base
        run: |
          BALANCE=$(cast balance --rpc-url "$BASE_RPC" \
            "${{ steps.addrs.outputs.faucet }}" | awk '{print $1}')
          echo "balance=$BALANCE" >> $GITHUB_OUTPUT
          echo "Faucet ETH on Base (wei): $BALANCE"

      - name: Check faucet USDC on Base
        id: faucet_usdc_base
        run: |
          BALANCE=$(cast call --rpc-url "$BASE_RPC" "$BASE_USDC" \
            "balanceOf(address)(uint256)" \
            "${{ steps.addrs.outputs.faucet }}" | awk '{print $1}')
          echo "balance=$BALANCE" >> $GITHUB_OUTPUT
          echo "Faucet USDC on Base (raw): $BALANCE"

      - name: Check faucet ETH on Optimism
        id: faucet_eth_op
        run: |
          BALANCE=$(cast balance --rpc-url "$OP_RPC" \
            "${{ steps.addrs.outputs.faucet }}" | awk '{print $1}')
          echo "balance=$BALANCE" >> $GITHUB_OUTPUT
          echo "Faucet ETH on Optimism (wei): $BALANCE"

      - name: Check faucet USDC on Optimism
        id: faucet_usdc_op
        run: |
          BALANCE=$(cast call --rpc-url "$OP_RPC" "$OP_USDC" \
            "balanceOf(address)(uint256)" \
            "${{ steps.addrs.outputs.faucet }}" | awk '{print $1}')
          echo "balance=$BALANCE" >> $GITHUB_OUTPUT
          echo "Faucet USDC on Optimism (raw): $BALANCE"

      - name: Check faucet SOL on Solana
        id: faucet_sol
        run: |
          RESPONSE=$(curl -sf -X POST "$SOL_RPC" \
            -H 'Content-Type: application/json' \
            -d "{\"jsonrpc\":\"2.0\",\"id\":1,\"method\":\"getBalance\",\"params\":[\"${{ steps.addrs.outputs.faucet_solana }}\"]}")
          ERROR=$(echo "$RESPONSE" | python3 -c 'import json,sys; d=json.load(sys.stdin); print(d.get("error") or "null")')
          if [ "$ERROR" != "null" ]; then
            echo "::error::RPC error: $ERROR"
            exit 1
          fi
          BALANCE=$(echo "$RESPONSE" | python3 -c 'import json,sys; print(json.load(sys.stdin)["result"]["value"])')
          echo "balance=$BALANCE" >> $GITHUB_OUTPUT
          echo "Faucet SOL on Solana (lamports): $BALANCE"

      - name: Prepare alert for pay wallet USDC on Base
        id: alert_pay_usdc_base
        run: |
          BALANCE="${{ steps.pay_usdc_base.outputs.balance }}"
          THRESHOLD="${{ vars.USDC_THRESHOLD_UNITS || '2000000' }}"
          if [ "$BALANCE" -lt "$THRESHOLD" ]; then
            BALANCE_HUMAN=$(echo "scale=2; $BALANCE / 1000000" | bc)
            THRESHOLD_HUMAN=$(echo "scale=2; $THRESHOLD / 1000000" | bc)
            ALERT_TEXT="Pay wallet USDC on Base is low: ${BALANCE_HUMAN} \
              USDC (threshold ${THRESHOLD_HUMAN} USDC) at \
              ${{ steps.addrs.outputs.pay }}"
            echo "should_alert=true" >> "$GITHUB_OUTPUT"
            echo "text=$ALERT_TEXT" >> "$GITHUB_OUTPUT"
            echo "::warning::$ALERT_TEXT"
          fi

      - name: Send Slack alert for pay wallet USDC on Base
        if: |
          steps.alert_pay_usdc_base.outputs.should_alert == 'true' &&
          env.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v2.1.0
        with:
          webhook: ${{ env.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "${{ steps.alert_pay_usdc_base.outputs.text }}"
            }

      - name: Skip Slack alert for pay wallet USDC on Base (no webhook)
        if: |
          steps.alert_pay_usdc_base.outputs.should_alert == 'true' &&
          env.SLACK_WEBHOOK_URL == ''
        run: |
          echo "::warning::SLACK_WEBHOOK_URL not configured, skipping alert"

      - name: Prepare alert for faucet ETH on Base
        id: alert_faucet_eth_base
        run: |
          BALANCE="${{ steps.faucet_eth_base.outputs.balance }}"
          THRESHOLD="${{ vars.ETH_THRESHOLD_WEI || '500000000000000' }}"
          if [ "$BALANCE" -lt "$THRESHOLD" ]; then
            BALANCE_HUMAN=$(echo "scale=6; $BALANCE / 1000000000000000000" | bc)
            THRESHOLD_HUMAN=$(echo "scale=6; $THRESHOLD / 1000000000000000000" | bc)
            ALERT_TEXT="Faucet ETH on Base is low: ${BALANCE_HUMAN} ETH \
              (threshold ${THRESHOLD_HUMAN} ETH) at \
              ${{ steps.addrs.outputs.faucet }}"
            echo "should_alert=true" >> "$GITHUB_OUTPUT"
            echo "text=$ALERT_TEXT" >> "$GITHUB_OUTPUT"
            echo "::warning::$ALERT_TEXT"
          fi

      - name: Send Slack alert for faucet ETH on Base
        if: |
          steps.alert_faucet_eth_base.outputs.should_alert == 'true' &&
          env.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v2.1.0
        with:
          webhook: ${{ env.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "${{ steps.alert_faucet_eth_base.outputs.text }}"
            }

      - name: Skip Slack alert for faucet ETH on Base (no webhook)
        if: |
          steps.alert_faucet_eth_base.outputs.should_alert == 'true' &&
          env.SLACK_WEBHOOK_URL == ''
        run: |
          echo "::warning::SLACK_WEBHOOK_URL not configured, skipping alert"

      - name: Prepare alert for faucet USDC on Base
        id: alert_faucet_usdc_base
        run: |
          BALANCE="${{ steps.faucet_usdc_base.outputs.balance }}"
          THRESHOLD="${{ vars.USDC_THRESHOLD_UNITS || '2000000' }}"
          if [ "$BALANCE" -lt "$THRESHOLD" ]; then
            BALANCE_HUMAN=$(echo "scale=2; $BALANCE / 1000000" | bc)
            THRESHOLD_HUMAN=$(echo "scale=2; $THRESHOLD / 1000000" | bc)
            ALERT_TEXT="Faucet USDC on Base is low: ${BALANCE_HUMAN} USDC \
              (threshold ${THRESHOLD_HUMAN} USDC) at \
              ${{ steps.addrs.outputs.faucet }}"
            echo "should_alert=true" >> "$GITHUB_OUTPUT"
            echo "text=$ALERT_TEXT" >> "$GITHUB_OUTPUT"
            echo "::warning::$ALERT_TEXT"
          fi

      - name: Send Slack alert for faucet USDC on Base
        if: |
          steps.alert_faucet_usdc_base.outputs.should_alert == 'true' &&
          env.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v2.1.0
        with:
          webhook: ${{ env.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "${{ steps.alert_faucet_usdc_base.outputs.text }}"
            }

      - name: Skip Slack alert for faucet USDC on Base (no webhook)
        if: |
          steps.alert_faucet_usdc_base.outputs.should_alert == 'true' &&
          env.SLACK_WEBHOOK_URL == ''
        run: |
          echo "::warning::SLACK_WEBHOOK_URL not configured, skipping alert"

      - name: Prepare alert for faucet ETH on Optimism
        id: alert_faucet_eth_op
        run: |
          BALANCE="${{ steps.faucet_eth_op.outputs.balance }}"
          THRESHOLD="${{ vars.ETH_THRESHOLD_WEI || '500000000000000' }}"
          if [ "$BALANCE" -lt "$THRESHOLD" ]; then
            BALANCE_HUMAN=$(echo "scale=6; $BALANCE / 1000000000000000000" | bc)
            THRESHOLD_HUMAN=$(echo "scale=6; $THRESHOLD / 1000000000000000000" | bc)
            ALERT_TEXT="Faucet ETH on Optimism is low: ${BALANCE_HUMAN} ETH \
              (threshold ${THRESHOLD_HUMAN} ETH) at \
              ${{ steps.addrs.outputs.faucet }}"
            echo "should_alert=true" >> "$GITHUB_OUTPUT"
            echo "text=$ALERT_TEXT" >> "$GITHUB_OUTPUT"
            echo "::warning::$ALERT_TEXT"
          fi

      - name: Send Slack alert for faucet ETH on Optimism
        if: |
          steps.alert_faucet_eth_op.outputs.should_alert == 'true' &&
          env.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v2.1.0
        with:
          webhook: ${{ env.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "${{ steps.alert_faucet_eth_op.outputs.text }}"
            }

      - name: Skip Slack alert for faucet ETH on Optimism (no webhook)
        if: |
          steps.alert_faucet_eth_op.outputs.should_alert == 'true' &&
          env.SLACK_WEBHOOK_URL == ''
        run: |
          echo "::warning::SLACK_WEBHOOK_URL not configured, skipping alert"

      - name: Prepare alert for faucet USDC on Optimism
        id: alert_faucet_usdc_op
        run: |
          BALANCE="${{ steps.faucet_usdc_op.outputs.balance }}"
          THRESHOLD="${{ vars.USDC_THRESHOLD_UNITS || '2000000' }}"
          if [ "$BALANCE" -lt "$THRESHOLD" ]; then
            BALANCE_HUMAN=$(echo "scale=2; $BALANCE / 1000000" | bc)
            THRESHOLD_HUMAN=$(echo "scale=2; $THRESHOLD / 1000000" | bc)
            ALERT_TEXT="Faucet USDC on Optimism is low: ${BALANCE_HUMAN} USDC \
              (threshold ${THRESHOLD_HUMAN} USDC) at \
              ${{ steps.addrs.outputs.faucet }}"
            echo "should_alert=true" >> "$GITHUB_OUTPUT"
            echo "text=$ALERT_TEXT" >> "$GITHUB_OUTPUT"
            echo "::warning::$ALERT_TEXT"
          fi

      - name: Send Slack alert for faucet USDC on Optimism
        if: |
          steps.alert_faucet_usdc_op.outputs.should_alert == 'true' &&
          env.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v2.1.0
        with:
          webhook: ${{ env.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "${{ steps.alert_faucet_usdc_op.outputs.text }}"
            }

      - name: Skip Slack alert for faucet USDC on Optimism (no webhook)
        if: |
          steps.alert_faucet_usdc_op.outputs.should_alert == 'true' &&
          env.SLACK_WEBHOOK_URL == ''
        run: |
          echo "::warning::SLACK_WEBHOOK_URL not configured, skipping alert"

      - name: Prepare alert for faucet SOL on Solana
        id: alert_faucet_sol
        run: |
          BALANCE="${{ steps.faucet_sol.outputs.balance }}"
          THRESHOLD="${{ vars.SOL_THRESHOLD_LAMPORTS || '100000000' }}"
          if [ "$BALANCE" -lt "$THRESHOLD" ]; then
            BALANCE_HUMAN=$(echo "scale=6; $BALANCE / 1000000000" | bc)
            THRESHOLD_HUMAN=$(echo "scale=6; $THRESHOLD / 1000000000" | bc)
            ALERT_TEXT="Faucet SOL on Solana is low: ${BALANCE_HUMAN} SOL \
              (threshold ${THRESHOLD_HUMAN} SOL) at \
              ${{ steps.addrs.outputs.faucet_solana }}"
            echo "should_alert=true" >> "$GITHUB_OUTPUT"
            echo "text=$ALERT_TEXT" >> "$GITHUB_OUTPUT"
            echo "::warning::$ALERT_TEXT"
          fi

      - name: Send Slack alert for faucet SOL on Solana
        if: |
          steps.alert_faucet_sol.outputs.should_alert == 'true' &&
          env.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v2.1.0
        with:
          webhook: ${{ env.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "${{ steps.alert_faucet_sol.outputs.text }}"
            }

      - name: Skip Slack alert for faucet SOL on Solana (no webhook)
        if: |
          steps.alert_faucet_sol.outputs.should_alert == 'true' &&
          env.SLACK_WEBHOOK_URL == ''
        run: |
          echo "::warning::SLACK_WEBHOOK_URL not configured, skipping alert"
